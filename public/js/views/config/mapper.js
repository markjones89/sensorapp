(window.webpackJsonp=window.webpackJsonp||[]).push([[7],{141:function(t,e,n){"use strict";n(59)},142:function(t,e,n){(t.exports=n(6)(!1)).push([t.i,"#sensor-mapper[data-v-34db8970]{display:flex;margin-top:24px;height:calc(100% - 64px)}#sensor-mapper .row[data-v-34db8970]{height:100%}#sensor-mapper #mapper-options[data-v-34db8970]{margin-bottom:24px}#sensor-mapper #mapper-options #switches[data-v-34db8970]{margin-top:16px}#sensor-mapper #mapper-options .vue-switcher[data-v-34db8970]{position:relative;display:inline-block;margin:5px 5px 20px}#sensor-mapper #floor-map[data-v-34db8970]{position:relative;flex:1 auto}",""])},15:function(t,e,n){"use strict";var r=n(2),o=n(0);e.a=function(t,e,n){var a=this,i=r.y(t),s=function(){return i.node().parentNode.getBoundingClientRect().width||800},l=function(){return i.node().parentNode.getBoundingClientRect().height||400},d=s(),c=l(),p=e,u=p.sensors||[],f=Object(o.e)({edit:!1,heatmap:!1,comfortmap:!1},n),g=f.events,m={x:0,y:0,scale:0},h={sensorMapping:!1,showSensors:!1,areaMapping:!1,showAreas:!1,drawing:!1,polyMoved:!1},_=[],v=r.w().domain([0,50]).range([0,d]),y=r.w().domain([0,33.79]).range([0,c]),b=this,w=r.x().domain([0,1,2]).range(["#01FE01","#FF8600","#ED0003"]),x=r.x().domain([0,1,2]).range(["rgba(1,254,1,0.3)","rgba(255,134,0,0.3)","rgba(237,0,3,0.3)"]);i.selectAll("svg").remove(),i.selectAll(".tooltip").remove();var S=i.append("div").attr("class","tooltip"),M=i.append("svg").attr("width",d).attr("height",c).style("display","block").style("background","#ffffff").on("click",(function(){if(f.edit){var t=r.i,e=document.elementFromPoint(t.x,t.y);if("svg"!==e.tagName){var n=k.__transform,o=n?(t.offsetX-n.x)/n.k:t.offsetX,a=n?(t.offsetY-n.y)/n.k:t.offsetY;if((n&&1===n.z||!n)&&(o-=m.x,a-=m.y),h.sensorMapping){var i="polygon"===e.tagName?r.y(e.parentNode).data()[0]:null;return g&&g.sensorAdd&&g.sensorAdd.call(b,{x:o,y:a,scale:m.scale,area:i})}}}}));f.events&&M.style("pointer-events","all"),(f.heatmap||f.comfortmap)&&M.append("defs").append("filter").attr("id","blur").attr("x","-50%").attr("y","-50%").attr("width","200%").attr("height","200%").append("feGaussianBlur").attr("stdDeviation",f.heatmap?7:15);var k=M.selectAll(".map-layer").data([0]).enter().append("g").attr("class","map-layer"),F=k.append("g").attr("class","image-layer"),A=k.append("g").attr("class","sensor-layer"),E=r.E().scaleExtent([1,8]).on("zoom",(function(){k.__transform=r.i.transform;var t=(1-k.__transform.k)*(v.range()[1]-v.range()[0]),e=(1-k.__transform.k)*(y.range()[1]-y.range()[0]);k.__transform.x=Math.min(v.range()[0],Math.max(k.__transform.x,t)),k.__transform.y=Math.min(y.range()[0],Math.max(k.__transform.y,e)),F.attr("transform",k.__transform),A.attr("transform",k.__transform)}));function C(t,e){var n=this,o=new Image;g&&g.imgLoad&&g.imgLoad.call(this,t),o.src=t,o.onload=function(){var t,a,i=l(),p=s(),u=o.height>i?i/o.height:p/o.width,f=Math.min(Math.min(o.width*u,o.width),p),m=Math.min(Math.min(o.height*u,o.height),i);return d=t=f,c=a=m,v=r.w().domain([0,50]).range([0,t]),y=r.w().domain([0,33.79]).range([0,a]),M.attr("width",t).attr("height",a),g&&g.imgLoaded&&g.imgLoaded.call(n,o),e&&e({height:o.height,width:o.width})}}function O(t){C(p.floor_plan_url,(function(e){var n=c-e.height<d-e.width?c/e.height:d/e.width,r=e.width*n,o=e.height*n,a=(d-r)/2,i=(c-o)/2;m.x=a<0?0:a,m.y=i<0?0:i,m.scale=n,t&&t()}))}function j(t,e,n){n&&S.html(n),S.style("left","".concat(t,"px")).style("top","".concat(e,"px"))}function P(t){f.edit&&h.sensorMapping&&(t.dragged=!0,r.y(this).attr("cx",t.pos_x=r.i.x).attr("cy",t.pos_y=r.i.y))}function D(t){if(f.edit&&h.sensorMapping&&t.dragged)return t.dragged=!1,t.pos_x-=m.x,t.pos_y-=m.y,t.scale=m.scale,g&&g.sensorMoved&&g.sensorMoved.call(b,t)}return k.call(E),this.drawFloorPlan=function(){if(F.selectAll("image").remove(),k.__transform&&F.attr("transform",k.__transform),p.floor_plan){var t=f.edit&&(h.sensorMapping||h.areaMapping);F.insert("image",":first-child").attr("xlink:href",p.floor_plan_url).attr("height",y(33.79)-y(0)).attr("width",v(50)-v(0)).style("cursor",(function(){return t?"crosshair":"default"}))}},this.drawSensors=function(){if(A.selectAll(".sensor").remove(),k.__transform&&A.attr("transform",k.__transform),0!==u.length){var t=f.edit&&h.sensorMapping;A.selectAll(".sensor").data(u).enter().append("circle").attr("class","sensor").attr("data-id",(function(t){return t.id})).attr("r",f.heatmap?15:f.comfortmap?35:5).attr("stroke-width",f.heatmap||f.comfortmap?null:5).attr("stroke",f.heatmap||f.comfortmap?null:x(0)).style("fill",w(0)).attr("filter",f.heatmap||f.comfortmap?"url(#blur)":null).style("cursor",(function(){return t?"move":"default"})).attr("cx",(function(t){var e=parseFloat(m.scale.toFixed(12));return t.pos_x/t.scale*e+m.x})).attr("cy",(function(t){var e=parseFloat(m.scale.toFixed(12));return t.pos_y/t.scale*e+m.y})).on("mouseover",(function(){if(!f.comfortmap){var t=r.y(this),e=u.find((function(e){return e.id===t.attr("data-id")}));S.transition().duration(200).style("opacity",.95),j(r.i.offsetX+15,r.i.offsetY-S.node().getBoundingClientRect().height/2,"<div>ID: ".concat(e.sensor_id,"</div><div>Name: ").concat(e.name?e.name:"(None)","</div>"))}})).on("mousemove",(function(){f.comfortmap||j(r.i.offsetX+15,r.i.offsetY-S.node().getBoundingClientRect().height/2)})).on("mouseout",(function(){f.comfortmap||S.transition().duration(200).style("opacity",0)})).on("click",(function(e){return t&&(function(t){g&&g.sensorClick&&g.sensorClick.call(b,t)}(e),r.i.stopPropagation())})).call(r.h().on("drag",P).on("end",D))}},this.setSensorColor=function(t,e){var n="occupied"===e?1:0;A.select('.sensor[data-id="'.concat(t,'"]')).style("fill",w(n)).attr("stroke",x(n))},this.setData=function(t){u=(p=t).sensors,k.__transform=null,this.redraw(!0)},this.redraw=function(t){var e=this;if(!p.floor_plan)return F.selectAll("image").remove(),void A.selectAll(".sensor").remove();t?(k.__transform=null,k.call(E.transform,r.F),O((function(){e.drawFloorPlan(),e.drawSensors()}))):(this.drawFloorPlan(),this.drawSensors()),this.clearDrawing()},this.editMode=function(t){f.edit=t,this.redraw(!1)},this.setAreaMapping=function(t){t&&(h.sensorMapping=!1),h.areaMapping=t,this.redraw(!1)},this.clearDrawing=function(){h.drawing=!1,_.splice(0)},this.setSensorMapping=function(t){t&&(h.areaMapping=!1),h.sensorMapping=t,this.redraw(!1)},p&&p.floor_plan&&O((function(){a.drawFloorPlan(),a.drawSensors()})),this}},304:function(t,e,n){"use strict";n.r(e);var r=n(1),o=n.n(r),a=n(5),i=n(0),s=n(4),l=n(15),d=n(8);function c(t,e,n,r,o,a,i){try{var s=t[a](i),l=s.value}catch(t){return void n(t)}s.done?e(l):Promise.resolve(l).then(r,o)}function p(t){return function(){var e=this,n=arguments;return new Promise((function(r,o){var a=t.apply(e,n);function i(t){c(a,r,o,i,s,"next",t)}function s(t){c(a,r,o,i,s,"throw",t)}i(void 0)}))}}function u(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function f(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?u(Object(n),!0).forEach((function(e){g(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):u(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function g(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var m="/api/floors",h="/api/sensors",_="/api/areas",v={title:"Floor Mapper",props:["bldg_id","bldg_name","floor_id"],components:{Loader:s.f,FilterDropdown:s.d,CaretIcon:d.a,Modal:s.h},data:function(){return{mapper:null,mapperLoading:!1,loaded:!1,areaTypes:[],floorAreas:[],filterFloor:!1,floorSel:null,editMapper:!1,editArea:!1,editSensor:!1,showEntry:!1,showAreaEntry:!1,editMode:!1,entry:{id:null,sensor:"",name:"",group:"",pos_x:0,pos_y:0,scale:0},state:{saving:!1,removing:!1}}},computed:f(f(f({},Object(a.e)({user:function(t){return t.user},company_id:function(t){return t.locations.client}})),Object(a.c)({api_header:"backend/api_header",api_buildings:"backend/api_buildings",api_building_overview:"backend/api_building_overview",api_sensors:"backend/api_sensors",api_sensor:"backend/api_sensor",api_sensors_by_node:"backend/api_sensors_by_node",buildings:"locations/getBuildings",building:"locations/getBuilding"})),{},{baseUrl:function(){return Object(i.g)()},floors:function(){return this.$store.getters["locations/getFloors"](this.bldg_id)},floorList:function(){return this.floors.sort((function(t,e){return t.number>e.number?1:t.number<e.number?-1:0})).map((function(t){return{label:"".concat(t.ordinal_no," Floor"),value:t.id}}))},floor:function(){var t=this;return this.floorSel?this.floors.find((function(e){return e.id===t.floorSel})):null}}),watch:{floorSel:function(t,e){var n=this;this.floor&&this.mapper&&this.getSensors(t,(function(){n.mapper.setData(n.floor)}))},editSensor:function(t){this.mapper&&this.mapper.setSensorMapping(t)}},methods:f(f({},Object(a.d)({setBuildings:"locations/setBuildings",setBuilding:"locations/setBuilding",setFloors:"locations/setFloors"})),{},{getAreaTypes:function(){var t=this;return p(o.a.mark((function e(){var n,r;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,axios.get("".concat(_,"/types"));case 2:n=e.sent,r=n.data,t.areaTypes=r;case 5:case"end":return e.stop()}}),e)})))()},getBuilding:function(t,e){var n=this;return p(o.a.mark((function r(){var a,i;return o.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(a=null,!(n.buildings.length>0)){r.next=5;break}a=n.buildings.find((function(e){return e.id==t})),r.next=10;break;case 5:return r.next=7,axios.get(n.api_buildings(n.company_id),n.api_header());case 7:i=r.sent,a=i.data.find((function(e){return e.id==t})),n.setBuildings(i.data);case 10:return n.setBuilding(a),r.abrupt("return",e&&e());case 12:case"end":return r.stop()}}),r)})))()},getFloors:function(t){var e=this;return p(o.a.mark((function n(){var r,a,s;return o.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,axios.all([axios.get(m,{bid:e.bldg_id}),axios.get(e.api_building_overview(e.company_id,e.bldg_id),e.api_header())]);case 2:return r=n.sent,a=r[0].data,(s=r[1].data.children).forEach((function(t){var n=a.find((function(e){return e.ref_id==t.id}));t.ordinal_no=Object(i.x)(t.number),t.occupancy_limit=null==n?void 0:n.occupancy_limit,t.floor_plan=null==n?void 0:n.floor_plan,t.floor_plan_url=null!=n&&n.floor_plan?"".concat(e.baseUrl,"/plans/").concat(n.floor_plan):null,t.upload_info={uploading:!1,progress:0},t.areas=t.children,delete t.children})),s.sort((function(t,e){return t.number>e.number?1:t.number<e.number?-1:0})),e.setFloors({bid:e.bldg_id,floors:s}),e.floor_id?e.floorSel=e.floor_id:e.floors.length>0&&(e.floorSel=e.floors[0].id),n.abrupt("return",t&&t());case 9:case"end":return n.stop()}}),n)})))()},getSensors:function(t,e){var n=this;return p(o.a.mark((function r(){var a,i,s,l;return o.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,axios.all([axios.get(n.api_sensors_by_node(t,"Floor"),n.api_header()),axios.get(h,{fid:t})]);case 2:return a=r.sent,i=n.floors.find((function(e){return e.id===t})),s=a[0].data,l=a[1].data,s.forEach((function(t){var e=l.find((function(e){return e.ref_id==t.id}));e&&(t.pos_x=e.pos_x,t.pos_y=e.pos_y,t.scale=e.scale)})),i.sensors=s,n.floorAreas=i.areas,r.abrupt("return",e&&e());case 9:case"end":return r.stop()}}),r)})))()},selectFloor:function(t){this.floorSel=t,this.filterFloor=!1},toggleEditMode:function(t){this.editMapper=t,this.editSensor=t,this.mapper.editMode(t)},toggleSensorMap:function(){this.mapper.setSensorMapping(this.editSensor)},setupMapper:function(){var t=this;t.mapper=new l.a("#floor-map",t.floor,g({events:!0},"events",{imgLoad:function(){t.mapperLoading=!0},imgLoaded:function(){t.mapperLoading=!1},sensorAdd:function(e){t.triggerAdd(e.x,e.y,e.scale,e.area)},sensorClick:function(e){t.triggerEdit(e.id)},sensorMoved:function(e){axios.put("".concat(h,"/coord/").concat(e.id),{floor_id:t.floorSel,pos_x:e.pos_x,pos_y:e.pos_y,scale:e.scale})}}))},toggleSaving:function(t){this.state.saving=t},toggleEntry:function(t){var e=this;this.showEntry=t,t&&setTimeout((function(){e.$refs.sensor.focus()}),0)},triggerAdd:function(t,e,n,r){this.entry.id=null,this.entry.sensor="",this.entry.name="",this.entry.pos_x=t,this.entry.pos_y=e,this.entry.scale=n,this.editMode=!1,this.toggleEntry(!0)},addSensor:function(){var t=this;return p(o.a.mark((function e(){var n,r,a;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.toggleSaving(!0),n=t.floorAreas.find((function(e){return e.id==t.entry.group})),r={sensor_id:t.entry.sensor,name:t.entry.name,parent:n.group_id},e.next=5,axios.post(t.api_sensors(t.company_id,t.bldg_id,t.floorSel,n.id),r,t.api_header());case 5:200==(a=e.sent).status?(r.id=a.data.child_id,axios.post(h,{ref_id:r.id,floor_id:t.floorSel,pos_x:t.entry.pos_x,pos_y:t.entry.pos_y,scale:t.entry.scale}).then((function(e){e.data.r&&(r.pos_x=t.entry.pos_x,r.pos_y=t.entry.pos_y,r.scale=t.entry.scale,t.floor.sensors.push(r),t.mapper.drawSensors(),t.toggleEntry(!1),t.toggleSaving(!1))}))):t.toggleSaving(!1);case 7:case"end":return e.stop()}}),e)})))()},triggerEdit:function(t){var e=this.floor.sensors.find((function(e){return e.id===t}));this.entry.id=t,this.entry.sensor=e.sensor_id,this.entry.name=e.name,this.entry.group=e.group_id,this.entry.pos_x=e.pos_x,this.entry.pos_y=e.pos_y,this.entry.scale=e.scale,this.editMode=!0,this.toggleEntry(!0)},upSensor:function(){var t=this;return p(o.a.mark((function e(){var n,r,a,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.toggleSaving(!0),n=t.floorAreas.find((function(e){return e.id==t.entry.group})),r={sensor_id:t.entry.sensor,name:t.entry.name,parent:n.group_id},a=t.entry.id,e.next=6,axios.put(t.api_sensor(t.company_id,t.bldg_id,t.floorSel,n.id,a),r,t.api_header());case 6:200==e.sent.status?((i=t.floor.sensors.find((function(e){return e.id===t.entry.id}))).sensor_id=r.sensor_id,i.name=r.name,i.parent=r.parent,t.mapper.drawSensors(),t.toggleEntry(!1),t.toggleSaving(!1)):t.toggleSaving(!1);case 8:case"end":return e.stop()}}),e)})))()},delSensor:function(){var t=this;return p(o.a.mark((function e(){var n,r,a,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r=(n=t).entry.id,a=n.floor.sensors.findIndex((function(t){return t.id===r})),i=n.floor.sensors[a],n.$duDialog(null,"Remove sensor <strong>".concat(i.sensor_id,"</strong>?"),{buttons:n.$duDialog.OK_CANCEL,okText:"Remove",callbacks:{okClick:function(t){this.hide(),n.state.removing=!0,axios.delete(n.api_sensor(n.company_id,n.bldg_id,n.floorSel,i.area_id),n.api_header).then((function(t){200==t.status?(axios.delete("".concat(h,"/").concat(r)),n.state.removing=!1,n.floor.sensors.splice(a,1),n.mapper.drawSensors(),n.toggleEntry(!1)):n.state.removing=!1}))}}});case 2:case"end":return e.stop()}}),e)})))()}}),created:function(){var t=this;return p(o.a.mark((function e(){return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t.getAreaTypes();case 2:case"end":return e.stop()}}),e)})))()},mounted:function(){var t=this,e=this.building,n=this.floors;if(e&&e.id===t.bldg_id)if(t.bldg=e,n.length>0){if(t.floor_id?t.floorSel=t.floor_id:t.floors.length>0&&(t.floorSel=t.floors[0].id),t.loaded=!0,!t.floor)return;setTimeout((function(){t.setupMapper()}),100)}else t.getFloors((function(){t.loaded=!0,t.getSensors(t.floor.id,(function(){t.setupMapper()}))}));else t.getBuilding(t.bldg_id,(function(){t.getFloors((function(){t.loaded=!0,t.getSensors(t.floor.id,(function(){t.setupMapper()}))}))}))}},y=(n(141),n(3)),b=Object(y.a)(v,(function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"content"},[t.loaded?n("div",{staticClass:"graph-header"},[n("h2",{staticClass:"page-title"},[t._v(t._s(t.building?t.building.name+" Mapping":"Mapping"))]),t._v(" "),n("div",{staticClass:"graph-filters"},[t.floor&&t.floor.floor_plan?[t.editMapper?n("a",{staticClass:"btn btn-primary mr-12",attrs:{href:"javascript:;"},on:{click:function(e){return t.toggleEditMode(!1)}}},[t._v("Close Edit")]):n("a",{staticClass:"btn btn-primary mr-12",attrs:{href:"javascript:;"},on:{click:function(e){return t.toggleEditMode(!0)}}},[t._v("Edit")])]:t._e(),t._v(" "),n("span",{staticClass:"graph-filter",on:{click:function(e){t.filterFloor=!t.filterFloor}}},[t._v("\n                "+t._s(t.floor?t.floor.ordinal_no+" Floor":"Select Floor")+"\n                "),n("span",{staticClass:"caret"},[n("caret-icon")],1),t._v(" "),n("filter-dropdown",{attrs:{filters:t.floorList,show:t.filterFloor},on:{onSelect:t.selectFloor}})],1)],2)]):t._e(),t._v(" "),t.loaded?[n("transition",{attrs:{name:"fade"}},[t.loaded?n("div",{attrs:{id:"sensor-mapper"}},[n("div",{staticClass:"floor-map",attrs:{id:"floor-map"}},[n("loader",{attrs:{show:t.mapperLoading,type:"spinner"}})],1)]):t._e()])]:t._e(),t._v(" "),n("modal",{attrs:{show:t.showEntry},on:{close:function(e){return t.toggleEntry(!1)}},scopedSlots:t._u([{key:"header",fn:function(){return[n("h2",[t._v(t._s(t.editMode?"Edit":"Add")+" Sensor")])]},proxy:!0},{key:"footer",fn:function(){return[t.editMode?t._e():n("button",{staticClass:"btn btn-primary",attrs:{disabled:t.state.saving},on:{click:t.addSensor}},[t._v(t._s(t.state.saving?"Adding...":"Add"))]),t._v(" "),t.editMode?[n("button",{staticClass:"btn btn-danger btn-link",attrs:{disabled:t.state.removing},on:{click:t.delSensor}},[t._v(t._s(t.state.removing?"Removing...":"Remove"))]),t._v(" "),n("button",{staticClass:"btn btn-primary",attrs:{disabled:t.state.saving},on:{click:t.upSensor}},[t._v(t._s(t.state.saving?"Updating...":"Update"))])]:t._e()]},proxy:!0}])},[t._v(" "),n("div",{attrs:{id:"entry-wrapper"}},[n("div",{staticClass:"input-field"},[n("label",[t._v("Sensor ID")]),t._v(" "),n("input",{directives:[{name:"model",rawName:"v-model",value:t.entry.sensor,expression:"entry.sensor"}],ref:"sensor",attrs:{type:"text"},domProps:{value:t.entry.sensor},on:{input:function(e){e.target.composing||t.$set(t.entry,"sensor",e.target.value)}}})]),t._v(" "),n("div",{staticClass:"input-field"},[n("label",[t._v("Name")]),t._v(" "),n("input",{directives:[{name:"model",rawName:"v-model",value:t.entry.name,expression:"entry.name"}],attrs:{type:"text",placeholder:"(Optional)"},domProps:{value:t.entry.name},on:{input:function(e){e.target.composing||t.$set(t.entry,"name",e.target.value)}}})]),t._v(" "),n("div",{staticClass:"input-field"},[n("label",[t._v("Group ID (Area)")]),t._v(" "),n("select",{directives:[{name:"model",rawName:"v-model",value:t.entry.group,expression:"entry.group"}],on:{change:function(e){var n=Array.prototype.filter.call(e.target.options,(function(t){return t.selected})).map((function(t){return"_value"in t?t._value:t.value}));t.$set(t.entry,"group",e.target.multiple?n:n[0])}}},t._l(t.floorAreas,(function(e){return n("option",{key:e.id,domProps:{value:e.id}},[t._v(t._s(e.group_id))])})),0)])])]),t._v(" "),n("loader",{attrs:{show:!t.loaded,type:"ripple"}})],2)}),[],!1,null,"34db8970",null);e.default=b.exports},59:function(t,e,n){var r=n(142);"string"==typeof r&&(r=[[t.i,r,""]]);var o={hmr:!0,transform:void 0,insertInto:void 0};n(7)(r,o);r.locals&&(t.exports=r.locals)}}]);