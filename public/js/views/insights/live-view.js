(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{102:function(t,e,a){"use strict";var n=a(24);a.n(n).a},103:function(t,e,a){(t.exports=a(7)(!1)).push([t.i,"#live-view[data-v-599fa49a] {\n  flex: 1 auto;\n  display: flex;\n  flex-direction: column;\n}\n#live-view #floor-plan[data-v-599fa49a] {\n  flex: 1 auto;\n  display: flex;\n  justify-content: center;\n}\n#live-view #floor-stats[data-v-599fa49a] {\n  display: flex;\n  margin-top: 32px;\n  justify-content: space-around;\n}\n#live-view .stat-group[data-v-599fa49a] {\n  display: inline-flex;\n  flex-direction: column;\n  color: #ffffff;\n  width: 100px;\n  margin-top: 24px;\n  overflow: hidden;\n}\n#live-view .stat-group span[data-v-599fa49a] {\n  padding: 4px;\n}\n#live-view .stat-group + .stat-group[data-v-599fa49a] {\n  margin-left: 24px;\n}\n#live-view .stat-group .stat[data-v-599fa49a] {\n  border-radius: 4px 4px 0 0;\n}\n#live-view .stat-group.free .stat[data-v-599fa49a] {\n  background-color: #3DCFA3;\n}\n#live-view .stat-group.occupied .stat[data-v-599fa49a] {\n  background-color: #FF5A09;\n}\n#live-view .stat-group .label[data-v-599fa49a] {\n  font-size: 12px;\n  line-height: 20px;\n  border-radius: 0 0 4px 4px;\n  background-color: rgba(43, 43, 43, 0.9);\n}\n#live-view .stat-group.free .label[data-v-599fa49a] {\n  background-color: rgba(61, 207, 163, 0.1);\n}\n#live-view .stat-group.occupied .label[data-v-599fa49a] {\n  background-color: rgba(255, 90, 9, 0.1);\n}",""])},209:function(t,e,a){"use strict";a.r(e);var n=a(1),s=a.n(n),r=a(5),o=a(6),i=a(2),l=a(37);function c(t,e,a,n,s,r,o){try{var i=t[r](o),l=i.value}catch(t){return void a(t)}i.done?e(l):Promise.resolve(l).then(n,s)}function d(t){return function(){var e=this,a=arguments;return new Promise((function(n,s){var r=t.apply(e,a);function o(t){c(r,n,s,o,i,"next",t)}function i(t){c(r,n,s,o,i,"throw",t)}o(void 0)}))}}var f="/api/locations",u="/api/floors",p={title:"Live",props:["bldg_id","floor_id"],components:{CaretIcon:o.a,CaretLeftIcon:o.b,FilterDropdown:i.d,Loader:i.e},data:function(){return{loaded:!1,mapper:null,showPageOpts:!1,showEmbed:!1,liveWS:null,building:null,floors:[],floor:null,showFilter:!1,floorFilter:null,stats:{desk_free:0,desk_occupied:0,rooms_free:0,rooms_occupied:0},sci_id:null}},computed:{baseUrl:function(){return Object(r.c)()},floorFilters:function(){return this.floors.map((function(t){return{value:t.hid,label:"".concat(t.ordinal_no," Floor")}}))},deskSensors:function(){return this.floor.sensors.filter((function(t){return t.area&&4===t.area.type_id}))},meetingRoomSensors:function(){return this.floor.sensors.filter((function(t){return t.area&&[2,3].indexOf(t.area.type_id)>=0}))}},methods:{wsConnect:function(){this.liveWS=new WebSocket("ws://sigfox.switchfi.co.za:1880/ws/request"),this.liveWS.onopen=this.wsOpened,this.liveWS.onmessage=this.wsMessaged,this.liveWS.onclose=this.wsClosed},wsOpened:function(t){console.log("Connected to live data websocket.",t)},wsMessaged:function(t){if(this.floor){var e=JSON.parse(t.data),a=JSON.parse(e.payload),n=a.sensor_id,s=a.sensor_state,r=(a.time,this.floor.sensors.find((function(t){return t.sensor_id===n})));r&&s&&(r.sensor_state=s,this.mapper.setSensorColor(r.hid,s),this.setStats())}},wsClosed:function(t){t.wasClean?console.log("Connection to live data closed",t.code,t.reason):(console.log("Connection to live data died, reconnecting..."),this.wsConnect())},wsClose:function(t){this.liveWS.close(1e3,t)},windowUnload:function(){this.wsClose("Page closed")},backTo:function(){this.$router.back()},filterSelect:function(t,e){var a=this;this.showFilter=!1,this.floor=this.floors.find((function(e){return e.hid===t})),this.floorFilter=e,this.getFloorData(t,(function(){a.mapper.setData(a.floor)}))},toHeatMap:function(){this.$router.push({name:"heat-map"})},toggleEmbed:function(t){t&&(this.showPageOpts=!1),this.showEmbed=t},getBuilding:function(t){var e=this;return d(s.a.mark((function a(){var n,r;return s.a.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,axios.get(f,{params:{id:t}});case 2:n=a.sent,r=n.data,e.building=r,e.getFloors(t,(function(){var t=e.floor_id?e.floor_id:e.floors[0].hid;e.floor=e.floors.find((function(e){return e.hid===t})),e.floorFilter="".concat(e.floor.ordinal_no," Floor"),e.getFloorData(t,(function(){e.loaded=!0,setTimeout((function(){e.setFloorMap()}),0)}))}));case 6:case"end":return a.stop()}}),a)})))()},getFloors:function(t,e){var a=this;return d(s.a.mark((function n(){var r,o,i;return s.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,axios.get(u,{params:{bid:t}});case 2:return r=n.sent,(o=r.data).forEach((function(t){t.floor_plan_url="".concat(a.baseUrl,"/plans/").concat(t.floor_plan)})),i=o.sort((function(t,e){return t.floor_no>e.floor_no?1:t.floor_no<e.floor_no?-1:0})),a.floors=i,n.abrupt("return",e&&e());case 8:case"end":return n.stop()}}),n)})))()},getFloorData:function(t,e){var a=this;return d(s.a.mark((function n(){var r,o;return s.a.wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,axios.get("".concat(u,"/").concat(t,"/data"),{params:{so:!0}});case 2:return r=n.sent,(o=r.data).sensors.forEach((function(t){t.sensor_state="available"})),a.floor.sensors=o.sensors,a.floor.areas=[],a.setStats(),n.abrupt("return",e&&e());case 9:case"end":return n.stop()}}),n)})))()},setFloorMap:function(){this.mapper=new l.a("#floor-map",this.floor)},setStats:function(){this.stats.desk_free=this.deskSensors.filter((function(t){return"available"===t.sensor_state})).length,this.stats.desk_occupied=Math.abs(this.deskSensors.length-this.stats.desk_free),this.stats.rooms_free=this.meetingRoomSensors.filter((function(t){return"available"===t.sensor_state})).length,this.stats.rooms_occupied=Math.abs(this.meetingRoomSensors.length-this.stats.rooms_free)}},created:function(){this.wsConnect()},mounted:function(){this.bldg_id&&this.getBuilding(this.bldg_id),Object(r.a)(window,"beforeunload",this.windowUnload)},destroyed:function(){this.wsClose("Page closed"),Object(r.g)(window,"beforeunload",this.windowUnload),clearInterval(this.sci_id)}},h=(a(102),a(3)),v=Object(h.a)(p,(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"content"},[t.loaded?a("div",{staticClass:"graph-wrapper"},[a("div",{staticClass:"graph-header"},[a("div",{staticClass:"page-back"},[a("div",{staticClass:"back-button",on:{click:t.backTo}},[a("button",{staticClass:"btn btn-primary btn-small"},[a("caret-left-icon")],1),t._v("\n                    Back\n                ")])]),t._v(" "),a("div",{staticClass:"graph-filters"},[a("span",{staticClass:"graph-filter",on:{click:function(e){t.showFilter=!t.showFilter}}},[t._v("\n                    "+t._s(t.floorFilter?t.floorFilter:"Select Floor")+"\n                    "),a("span",{staticClass:"caret"},[a("caret-icon")],1),t._v(" "),a("filter-dropdown",{attrs:{filters:t.floorFilters,show:t.showFilter},on:{onSelect:t.filterSelect}})],1),t._v(" "),a("a",{staticClass:"btn btn-primary ml-12",attrs:{href:"javascript:;"},on:{click:t.toHeatMap}},[t._v("Heatmap")])]),t._v(" "),a("span",{staticClass:"page-opt-trigger",attrs:{role:"button"},on:{click:function(e){t.showPageOpts=!t.showPageOpts}}},[a("span",{staticClass:"dot"}),t._v(" "),a("span",{staticClass:"dot"}),t._v(" "),a("span",{staticClass:"dot"})]),t._v(" "),a("transition",{attrs:{name:"fadeUp"}},[t.showPageOpts?a("div",{staticClass:"page-opt-panel"},[a("ul",[a("li",[a("a",{on:{click:function(e){return t.toggleEmbed(!0)}}},[t._v("Embed")])])])]):t._e()])],1),t._v(" "),a("div",{staticClass:"graph-content"},[a("div",{staticClass:"chart-header"},[a("span",{staticClass:"chart-title"},[t._v(t._s(t.floor.ordinal_no+" Floor")+" Live View")]),t._v(" "),a("span",{staticClass:"chart-subtitle"},[t._v(t._s(t.building.name))])]),t._v(" "),a("div",{attrs:{id:"live-view"}},[t._m(0),t._v(" "),a("div",{attrs:{id:"floor-stats"}},[a("div",{attrs:{id:"desk-stats"}},[t._v("\n                        Desks\n                        "),a("div",{staticClass:"stats-wrapper"},[a("div",{staticClass:"stat-group free"},[a("span",{staticClass:"stat"},[t._v(t._s(t.stats.desk_free))]),t._v(" "),a("span",{staticClass:"label"},[t._v("Free")])]),t._v(" "),a("div",{staticClass:"stat-group occupied"},[a("span",{staticClass:"stat"},[t._v(t._s(t.stats.desk_occupied))]),t._v(" "),a("span",{staticClass:"label"},[t._v("Occupied")])])])]),t._v(" "),a("div",{attrs:{id:"meeting-rooms-stats"}},[t._v("\n                        Meeting Rooms\n                        "),a("div",{staticClass:"stats-wrapper"},[a("div",{staticClass:"stat-group free"},[a("span",{staticClass:"stat"},[t._v(t._s(t.stats.rooms_free))]),t._v(" "),a("span",{staticClass:"label"},[t._v("Free")])]),t._v(" "),a("div",{staticClass:"stat-group occupied"},[a("span",{staticClass:"stat"},[t._v(t._s(t.stats.rooms_occupied))]),t._v(" "),a("span",{staticClass:"label"},[t._v("Occupied")])])])])])])])]):t._e(),t._v(" "),a("loader",{attrs:{show:!t.loaded,type:"ripple"}})],1)}),[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{attrs:{id:"floor-plan"}},[e("div",{staticClass:"floor-map",attrs:{id:"floor-map"}})])}],!1,null,"599fa49a",null);e.default=v.exports},24:function(t,e,a){var n=a(103);"string"==typeof n&&(n=[[t.i,n,""]]);var s={hmr:!0,transform:void 0,insertInto:void 0};a(8)(n,s);n.locals&&(t.exports=n.locals)},37:function(t,e,a){"use strict";var n=a(0),s=a(5);e.a=function(t,e,a){var r=this,o=n.z(t),i=o.node().getBoundingClientRect(),l=o.node().parentNode.getBoundingClientRect(),c=i.width||l.width,d=i.height||l.height,f=800,u=487,p=e,h=p.sensors||[],v=p.areas||[],g=Object(s.b)({edit:!1},a),m={x:0,y:0,scale:0},_={sensorMapping:!1,showSensors:!1,areaMapping:!1,showAreas:!1,drawing:!1,polyMoved:!1},w=[],y=n.x().domain([0,50]).range([0,f]),x=n.x().domain([0,33.79]).range([0,u]),b=this,k=n.y().domain([0,1,2]).range(["#01FE01","#FF8600","#ED0003"]),C=n.y().domain([0,1,2]).range(["rgba(1,254,1,0.3)","rgba(255,134,0,0.3)","rgba(237,0,3,0.3)"]);console.log("colors",k(0),C(0)),o.selectAll("svg").remove(),o.selectAll(".tooltip").remove();var F=o.append("div").attr("class","tooltip"),M=o.append("svg").attr("width",f).attr("height",u).style("display","block").style("background","#ffffff").on("click",(function(){if(g.edit){var t=n.i,e=document.elementFromPoint(t.x,t.y);if("svg"!==e.tagName){var a=S.__transform,s=a?(t.offsetX-a.x)/a.k:t.offsetX,r=a?(t.offsetY-a.y)/a.k:t.offsetY;if((a&&1===a.z||!a)&&(s-=m.x,r-=m.y),_.sensorMapping){var o="polygon"===e.tagName?n.z(e.parentNode).data()[0]:null;return g.events&&g.events.sensorAdd&&g.events.sensorAdd.call(b,{x:s,y:r,scale:m.scale,area:o})}if(_.areaMapping){var i={x:a?(t.offsetX-a.x)/a.k:t.offsetX,y:a?(t.offsetY-a.y)/a.k:t.offsetY},l=z.select("g.area-draw");l.empty()?function(t){_.drawing=!0,j(z.append("g").attr("class","area-draw"),t)}(i):j(l,i)}}}})),S=M.selectAll(".map-layer").data([0]).enter().append("g").attr("class","map-layer"),A=S.append("g").attr("class","image-layer"),z=S.append("g").attr("class","area-layer"),P=S.append("g").attr("class","sensor-layer"),B=n.E().scaleExtent([1,8]).on("zoom",(function(){S.__transform=n.i.transform;var t=(1-S.__transform.k)*(y.range()[1]-y.range()[0]),e=(1-S.__transform.k)*(x.range()[1]-x.range()[0]);S.__transform.x=Math.min(y.range()[0],Math.max(S.__transform.x,t)),S.__transform.y=Math.min(x.range()[0],Math.max(S.__transform.y,e)),A.attr("transform",S.__transform),P.attr("transform",S.__transform),z.attr("transform",S.__transform)}));function D(t,e){var a=new Image;a.src=t,a.onload=function(){var t,s,r=d-a.height<c-a.width?d/a.height:c/a.width,o=Math.min(a.width*r,a.width),i=Math.min(a.height*r,a.height);return f=t=o,u=s=i,y=n.x().domain([0,50]).range([0,t]),x=n.x().domain([0,33.79]).range([0,s]),M.attr("width",t).attr("height",s),e&&e({height:a.height,width:a.width})}}function N(t){D(p.floor_plan_url,(function(e){var a=u-e.height<f-e.width?u/e.height:f/e.width,n=e.width*a,s=e.height*a,r=(f-n)/2,o=(u-s)/2;m.x=r<0?0:r,m.y=o<0?0:o,m.scale=a,t&&t()}))}function O(t,e,a){a&&F.html(a),F.style("left","".concat(t,"px")).style("top","".concat(e,"px"))}function j(t,e){w.push(e),t.select("polyline").remove(),t.insert("polyline",":first-child").data(w).attr("points",(function(){return w.map((function(t){return[t.x,t.y].join(",")})).join(" ")})).style("fill","none").attr("stroke","#53DBF3"),t.append("circle").attr("cx",e.x).attr("cy",e.y).attr("r",4).attr("fill","#FFEB3B").attr("stroke","#53DBF3").style("cursor","pointer").on("click",(function(){return function(){z.select("g.area-draw").remove();var t=(e=w,m.scale,e.map((function(t){return[t.x-m.x,t.y-m.y].join(",")})).join(" "));var e;return U(w),w.splice(0),_.drawing=!1,g.events&&g.events.addArea&&g.events.addArea.call(b,t,m.scale)}()}))}function E(t,e){return t.map((function(t){var a=parseFloat(m.scale.toFixed(12));return[t.x/e*a+m.x,t.y/e*a+m.y].join(",")})).join(" ")}function R(t){return t.map((function(t){return[t.x,t.y].join(",")})).join(" ")}function U(t,e){var a=z.append("g").attr("class",e?"area":"area unsaved"),s=g.edit&&_.areaMapping;a.append("polygon").attr("points",e?E(t,e.scale):R(t)).style("fill","#53DBF3").style("opacity",.2).style("cursor",(function(){return s?"move":_.sensorMapping?"crosshair":"default"})).on("click",(function(t){return s&&(function(t){g.events&&g.events.areaClick&&g.events.areaClick.call(b,t)}(e),n.i.stopPropagation())})).on("mouseover",(function(t){_.sensorMapping||(F.transition().duration(200).style("opacity",.9),O(n.i.offsetX+15,n.i.offsetY-F.node().getBoundingClientRect().height/2,e.name))})).on("mousemove",(function(){_.polyMoved||_.sensorMapping||O(n.i.offsetX+15,n.i.offsetY-F.node().getBoundingClientRect().height/2)})).on("mouseout",(function(){F.transition().duration(200).style("opacity",0)})).call(n.h().on("drag",X).on("end",Y));e&&a.data([e]),s&&a.selectAll("circles").data(t).enter().append("circle").attr("cx",(function(t){return e?t.x/e.scale*parseFloat(m.scale.toFixed(12))+m.x:t.x})).attr("cy",(function(t){return e?t.y/e.scale*parseFloat(m.scale.toFixed(12))+m.y:t.y})).attr("r",4).attr("fill","#FFEB3B").attr("stroke","#53DBF3").style("cursor","move").call(n.h().on("drag",W).on("end",I))}function X(){if(g.edit&&_.areaMapping){var t,e=n.i,a=e.dx,s=e.dy,r=n.z(this),o=n.z(this.parentNode).selectAll("circle"),i=[],l=n.z(this.parentNode).data()[0];_.polyMoved=0!==a||0!==s,o.each((function(e){t=n.z(this),e.x+=a,e.y+=s,t.attr("cx",(function(t){return l?e.x/l.scale*parseFloat(m.scale.toFixed(12))+m.x:e.x})).attr("cy",(function(t){return l?e.y/l.scale*parseFloat(m.scale.toFixed(12))+m.y:e.y})),i.push({x:e.x,y:e.y})})),r.attr("points",E(i,l.scale))}}function Y(){if(g.edit&&_.areaMapping){var t=n.z(this.parentNode).data()[0],e=n.z(this.parentNode).selectAll("circle"),a=[];if(!_.polyMoved)return;_.polyMoved=!1,e.each((function(t){return a.push({x:t.x,y:t.y})}));var s=R(a);return g.events&&g.events.areaPtUpdate&&g.events.areaPtUpdate.call(b,0===t?null:t,s,m.scale)}}function W(t){t.dragged=!0;var e=n.i,a=n.z(this),s=[],r=n.z(this.parentNode).select("polygon"),o=n.z(this.parentNode).selectAll("circle"),i=n.z(this.parentNode).data()[0];a.attr("cx",e.x+m.x).attr("cy",e.y+m.y),t.x+=e.dx,t.y+=e.dy,o.each((function(t){return s.push({x:t.x,y:t.y})})),r.attr("points",E(s,i.scale))}function I(t){if(t.dragged){t.dragged=!1;var e=[],a=n.z(this.parentNode).selectAll("circle"),s=n.z(this.parentNode).data()[0];a.each((function(t){return e.push({x:t.x,y:t.y})}));var r=R(e);return g.events&&g.events.areaPtUpdate&&g.events.areaPtUpdate.call(b,0===s?null:s,r,m.scale)}}function J(t){g.edit&&_.sensorMapping&&(t.dragged=!0,n.z(this).attr("cx",t.pos_x=n.i.x).attr("cy",t.pos_y=n.i.y))}function L(t){if(g.edit&&_.sensorMapping&&t.dragged)return t.dragged=!1,t.pos_x-=m.x,t.pos_y-=m.y,t.scale=m.scale,g.events&&g.events.sensorMoved&&g.events.sensorMoved.call(b,t)}return S.call(B).on("mousemove",(function(){if(_.drawing){var t=z.select("g.area-draw");t.select("line").remove();var e=w[w.length-1],a=n.i,s=S.__transform,r=s?(a.offsetX-s.x)/s.k:a.offsetX,o=s?(a.offsetY-s.y)/s.k:a.offsetY;t.insert("line",":nth-child(2)").attr("x1",e.x).attr("y1",e.y).attr("x2",r).attr("y2",o).attr("stroke","#53DBF3").attr("stroke-width",1).style("pointer-events","none")}})),this.drawFloorPlan=function(){if(A.selectAll("image").remove(),S.__transform&&A.attr("transform",S.__transform),p.floor_plan){var t=g.edit&&(_.sensorMapping||_.areaMapping);A.insert("image",":first-child").attr("xlink:href",p.floor_plan_url).attr("height",x(33.79)-x(0)).attr("width",y(50)-y(0)).style("cursor",(function(){return t?"crosshair":"default"}))}},this.drawSensors=function(){if(P.selectAll(".sensor").remove(),S.__transform&&P.attr("transform",S.__transform),0!==h.length){var t=g.edit&&_.sensorMapping;P.selectAll(".sensor").data(h).enter().append("circle").attr("class","sensor").attr("data-id",(function(t){return t.hid})).attr("r","5").attr("stroke-width",5).attr("stroke",C(0)).style("fill",k(0)).style("cursor",(function(){return t?"move":"default"})).attr("cx",(function(t){var e=parseFloat(m.scale.toFixed(12));return t.pos_x/t.scale*e+m.x})).attr("cy",(function(t){var e=parseFloat(m.scale.toFixed(12));return t.pos_y/t.scale*e+m.y})).on("mouseover",(function(){var t=n.z(this),e=h.find((function(e){return e.hid===t.attr("data-id")}));F.transition().duration(200).style("opacity",.95),O(n.i.offsetX+15,n.i.offsetY-F.node().getBoundingClientRect().height/2,"<div>ID: ".concat(e.sensor_id,"</div><div>Name: ").concat(e.name?e.name:"(None)","</div>"))})).on("mousemove",(function(){O(n.i.offsetX+15,n.i.offsetY-F.node().getBoundingClientRect().height/2)})).on("mouseout",(function(){F.transition().duration(200).style("opacity",0)})).on("click",(function(e){return t&&(function(t){g.events&&g.events.sensorClick&&g.events.sensorClick.call(b,t)}(e),n.i.stopPropagation())})).call(n.h().on("drag",J).on("end",L))}},this.setSensorColor=function(t,e){var a="occupied"===e?1:0;P.select('.sensor[data-id="'.concat(t,'"]')).style("fill",k(a)).attr("stroke",C(a))},this.drawAreas=function(){z.selectAll("g.area").remove(),S.__transform&&z.attr("transform",S.__transform),0!==v.length&&v.forEach((function(t){return U(t.poly_points,t)}))},this.setData=function(t){h=(p=t).sensors,v=p.areas,S.__transform=null,this.redraw(!0)},this.redraw=function(t){var e=this;t&&(S.__transform=null,S.call(B.transform,n.F)),this.clearDrawing(),N((function(){e.drawFloorPlan(),e.drawAreas(),e.drawSensors()}))},this.editMode=function(t){g.edit=t,this.redraw(!1)},this.setAreaMapping=function(t){t&&(_.sensorMapping=!1),_.areaMapping=t,this.redraw(!1)},this.clearDrawing=function(){_.drawing=!1,w.splice(0),z.select("g.area-draw").remove(),z.select("g.area.unsaved").remove()},this.setSensorMapping=function(t){t&&(_.areaMapping=!1),_.sensorMapping=t,this.redraw(!1)},p&&N((function(){r.drawFloorPlan(),r.drawAreas(),r.drawSensors()})),this}}}]);