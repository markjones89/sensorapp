(window.webpackJsonp=window.webpackJsonp||[]).push([[15],{113:function(t,e,a){"use strict";a(48)},114:function(t,e,a){(t.exports=a(7)(!1)).push([t.i,"#live-view[data-v-521cbd48]{flex:1 auto;display:flex;flex-direction:column}#live-view #floor-plan[data-v-521cbd48]{flex:1 auto;display:flex;justify-content:center}#live-view #floor-stats[data-v-521cbd48]{display:flex;margin-top:32px;justify-content:space-around}#live-view .stat-group[data-v-521cbd48]{display:inline-flex;flex-direction:column;color:#fff;width:100px;margin-top:24px;overflow:hidden}#live-view .stat-group span[data-v-521cbd48]{padding:4px}#live-view .stat-group+.stat-group[data-v-521cbd48]{margin-left:24px}#live-view .stat-group .stat[data-v-521cbd48]{border-radius:4px 4px 0 0}#live-view .stat-group.free .stat[data-v-521cbd48]{background-color:#3dcfa3}#live-view .stat-group.occupied .stat[data-v-521cbd48]{background-color:#ff5a09}#live-view .stat-group .label[data-v-521cbd48]{font-size:12px;line-height:20px;border-radius:0 0 4px 4px;background-color:rgba(43,43,43,.9)}#live-view .stat-group.free .label[data-v-521cbd48]{background-color:rgba(61,207,163,.1)}#live-view .stat-group.occupied .label[data-v-521cbd48]{background-color:rgba(255,90,9,.1)}",""])},12:function(t,e,a){"use strict";var o=a(1),r=a(4);e.a=function(t,e,a){var n=this,s=o.y(t),i=function(){return s.node().parentNode.getBoundingClientRect().width||800},l=function(){return s.node().parentNode.getBoundingClientRect().height||400},c=i(),d=l(),u=e,f=u.sensors||[],p=Object(r.b)({edit:!1,heatmap:!1,comfortmap:!1},a),h=p.events,v={x:0,y:0,scale:0},g={sensorMapping:!1,showSensors:!1,areaMapping:!1,showAreas:!1,drawing:!1,polyMoved:!1},m=[],_=o.w().domain([0,50]).range([0,c]),b=o.w().domain([0,33.79]).range([0,d]),w=this,y=o.x().domain([0,1,2]).range(["#01FE01","#FF8600","#ED0003"]),x=o.x().domain([0,1,2]).range(["rgba(1,254,1,0.3)","rgba(255,134,0,0.3)","rgba(237,0,3,0.3)"]);s.selectAll("svg").remove(),s.selectAll(".tooltip").remove();var C=s.append("div").attr("class","tooltip"),k=s.append("svg").attr("width",c).attr("height",d).style("display","block").style("background","#ffffff").on("click",(function(){if(p.edit){var t=o.i,e=document.elementFromPoint(t.x,t.y);if("svg"!==e.tagName){var a=F.__transform,r=a?(t.offsetX-a.x)/a.k:t.offsetX,n=a?(t.offsetY-a.y)/a.k:t.offsetY;if((a&&1===a.z||!a)&&(r-=v.x,n-=v.y),g.sensorMapping){var s="polygon"===e.tagName?o.y(e.parentNode).data()[0]:null;return h&&h.sensorAdd&&h.sensorAdd.call(w,{x:r,y:n,scale:v.scale,area:s})}}}}));p.events&&k.style("pointer-events","all"),(p.heatmap||p.comfortmap)&&k.append("defs").append("filter").attr("id","blur").attr("x","-50%").attr("y","-50%").attr("width","200%").attr("height","200%").append("feGaussianBlur").attr("stdDeviation",p.heatmap?7:15);var F=k.selectAll(".map-layer").data([0]).enter().append("g").attr("class","map-layer"),M=F.append("g").attr("class","image-layer"),S=F.append("g").attr("class","sensor-layer"),O=o.D().scaleExtent([1,8]).on("zoom",(function(){F.__transform=o.i.transform;var t=(1-F.__transform.k)*(_.range()[1]-_.range()[0]),e=(1-F.__transform.k)*(b.range()[1]-b.range()[0]);F.__transform.x=Math.min(_.range()[0],Math.max(F.__transform.x,t)),F.__transform.y=Math.min(b.range()[0],Math.max(F.__transform.y,e)),M.attr("transform",F.__transform),S.attr("transform",F.__transform)}));function j(t,e){var a=this,r=new Image;h&&h.imgLoad&&h.imgLoad.call(this,t),r.src=t,r.onload=function(){var t,n,s=l(),u=i(),f=r.height>s?s/r.height:u/r.width,p=Math.min(Math.min(r.width*f,r.width),u),v=Math.min(Math.min(r.height*f,r.height),s);return c=t=p,d=n=v,_=o.w().domain([0,50]).range([0,t]),b=o.w().domain([0,33.79]).range([0,n]),k.attr("width",t).attr("height",n),h&&h.imgLoaded&&h.imgLoaded.call(a,r),e&&e({height:r.height,width:r.width})}}function P(t){j(u.floor_plan_url,(function(e){var a=d-e.height<c-e.width?d/e.height:c/e.width,o=e.width*a,r=e.height*a,n=(c-o)/2,s=(d-r)/2;v.x=n<0?0:n,v.y=s<0?0:s,v.scale=a,t&&t()}))}function D(t,e,a){a&&C.html(a),C.style("left","".concat(t,"px")).style("top","".concat(e,"px"))}function E(t){p.edit&&g.sensorMapping&&(t.dragged=!0,o.y(this).attr("cx",t.pos_x=o.i.x).attr("cy",t.pos_y=o.i.y))}function A(t){if(p.edit&&g.sensorMapping&&t.dragged)return t.dragged=!1,t.pos_x-=v.x,t.pos_y-=v.y,t.scale=v.scale,h&&h.sensorMoved&&h.sensorMoved.call(w,t)}return F.call(O),this.drawFloorPlan=function(){if(M.selectAll("image").remove(),F.__transform&&M.attr("transform",F.__transform),u.floor_plan){var t=p.edit&&(g.sensorMapping||g.areaMapping);M.insert("image",":first-child").attr("xlink:href",u.floor_plan_url).attr("height",b(33.79)-b(0)).attr("width",_(50)-_(0)).style("cursor",(function(){return t?"crosshair":"default"}))}},this.drawSensors=function(){if(S.selectAll(".sensor").remove(),F.__transform&&S.attr("transform",F.__transform),0!==f.length){var t=p.edit&&g.sensorMapping;S.selectAll(".sensor").data(f).enter().append("circle").attr("class","sensor").attr("data-id",(function(t){return t.id})).attr("r",p.heatmap?15:p.comfortmap?35:5).attr("stroke-width",p.heatmap||p.comfortmap?null:5).attr("stroke",p.heatmap||p.comfortmap?null:x(0)).style("fill",y(0)).attr("filter",p.heatmap||p.comfortmap?"url(#blur)":null).style("cursor",(function(){return t?"move":"default"})).attr("cx",(function(t){var e=parseFloat(v.scale.toFixed(12));return t.pos_x/t.scale*e+v.x})).attr("cy",(function(t){var e=parseFloat(v.scale.toFixed(12));return t.pos_y/t.scale*e+v.y})).on("mouseover",(function(){if(!p.comfortmap){var t=o.y(this),e=f.find((function(e){return e.id===t.attr("data-id")}));C.transition().duration(200).style("opacity",.95),D(o.i.offsetX+15,o.i.offsetY-C.node().getBoundingClientRect().height/2,"<div>ID: ".concat(e.sensor_id,"</div><div>Name: ").concat(e.name?e.name:"(None)","</div>"))}})).on("mousemove",(function(){p.comfortmap||D(o.i.offsetX+15,o.i.offsetY-C.node().getBoundingClientRect().height/2)})).on("mouseout",(function(){p.comfortmap||C.transition().duration(200).style("opacity",0)})).on("click",(function(e){return t&&(function(t){h&&h.sensorClick&&h.sensorClick.call(w,t)}(e),o.i.stopPropagation())})).call(o.h().on("drag",E).on("end",A))}},this.setSensorColor=function(t,e){var a="occupied"===e?1:0;S.select('.sensor[data-id="'.concat(t,'"]')).style("fill",y(a)).attr("stroke",x(a))},this.setData=function(t){f=(u=t).sensors,F.__transform=null,this.redraw(!0)},this.redraw=function(t){var e=this;if(!u.floor_plan)return M.selectAll("image").remove(),void S.selectAll(".sensor").remove();t?(F.__transform=null,F.call(O.transform,o.E),P((function(){e.drawFloorPlan(),e.drawSensors()}))):(this.drawFloorPlan(),this.drawSensors()),this.clearDrawing()},this.editMode=function(t){p.edit=t,this.redraw(!1)},this.setAreaMapping=function(t){t&&(g.sensorMapping=!1),g.areaMapping=t,this.redraw(!1)},this.clearDrawing=function(){g.drawing=!1,m.splice(0)},this.setSensorMapping=function(t){t&&(g.areaMapping=!1),g.sensorMapping=t,this.redraw(!1)},u&&u.floor_plan&&P((function(){n.drawFloorPlan(),n.drawSensors()})),this}},257:function(t,e,a){"use strict";a.r(e);var o=a(0),r=a.n(o),n=a(4),s=a(6),i=a(2),l=a(12),c=a(5);function d(t,e,a,o,r,n,s){try{var i=t[n](s),l=i.value}catch(t){return void a(t)}i.done?e(l):Promise.resolve(l).then(o,r)}function u(t){return function(){var e=this,a=arguments;return new Promise((function(o,r){var n=t.apply(e,a);function s(t){d(n,o,r,s,i,"next",t)}function i(t){d(n,o,r,s,i,"throw",t)}s(void 0)}))}}function f(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(t);e&&(o=o.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),a.push.apply(a,o)}return a}function p(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?f(Object(a),!0).forEach((function(e){h(t,e,a[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):f(Object(a)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))}))}return t}function h(t,e,a){return e in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}var v="/api/floors",g="/api/sensors",m={title:"Live",props:["bldg_id","floor_id"],components:{CaretIcon:s.a,CaretLeftIcon:s.b,FilterDropdown:i.d,Loader:i.e},data:function(){return{loaded:!1,mapper:null,showPageOpts:!1,showEmbed:!1,liveWS:null,building:null,floors:[],floor:null,showFilter:!1,floorFilter:null,stats:{desk_free:0,desk_occupied:0,rooms_free:0,rooms_occupied:0},sci_id:null}},computed:p(p(p({},Object(c.d)({user:function(t){return t.user}})),Object(c.b)({api_header:"backend/api_header",api_building_overview:"backend/api_building_overview",api_floors:"backend/api_floors",api_sensors_by_node:"backend/api_sensors_by_node"})),{},{baseUrl:function(){return Object(n.c)()},floorFilters:function(){return this.floors.map((function(t){return{value:t.id,label:"".concat(t.ordinal_no," Floor")}}))},deskSensors:function(){return this.floor.sensors.filter((function(t){return t.area&&4===t.area.type_id}))},meetingRoomSensors:function(){return this.floor.sensors.filter((function(t){return t.area&&[2,3].indexOf(t.area.type_id)>=0}))}}),methods:{wsMessaged:function(t){console.log("wsMessaged: ",t,this.floor),this.floor},wsClosed:function(t){},wsClose:function(){this.liveWS.disconnect()},windowUnload:function(){this.wsClose()},wsConnect:function(){var t=this;this.liveWS=new Paho.MQTT.Client("mqtt.intuitive.works",443,"intuitive_app_".concat(parseInt(100*Math.random(),10))),this.liveWS.onConnectionLost=function(t){console.log("wsClosed: ",t)},this.liveWS.onMessageArrived=function(e){if(t.floor){var a=JSON.parse(e.payloadString),o=a.sensorId,r=a.occupancy_status,n="0"==r?"available":"1"==r?"occupied":null,s=t.floor.sensors.find((function(t){return t.sensor_id===o}));s&&n&&(s.sensor_state=n,t.mapper.setSensorColor(s.id,n),t.setStats(),console.log("onMessageArrived",s))}},this.liveWS.connect({useSSL:!0,userName:"intuitive-api",password:"TRuhC3jBFrb3",onSuccess:function(){console.log("wsConnect.onSuccess"),t.liveWS.subscribe("sensor_data/#",{onSuccess:function(){return console.info("wsConnect: subscribe.onSuccess")},onFailure:function(){return console.log("wsConnect: subscribe.onFailure")}})},onFailure:function(t){console.log("wsConnect.onFailure: ",t)}})},backTo:function(){this.$router.back()},filterSelect:function(t,e){var a=this;return u(r.a.mark((function o(){return r.a.wrap((function(o){for(;;)switch(o.prev=o.next){case 0:return a.showFilter=!1,a.floor=a.floors.find((function(e){return e.id===t})),a.floorFilter=e,o.next=5,a.getFloorData(t);case 5:a.mapper.setData(a.floor);case 6:case"end":return o.stop()}}),o)})))()},toHeatMap:function(){this.$router.push({name:"heat-map",query:{bid:this.bldg_id,fid:this.floor.id}})},toComfortMap:function(){this.$router.push({name:"comfort-map",query:{bid:this.bldg_id,fid:this.floor.id}})},toggleEmbed:function(t){t&&(this.showPageOpts=!1),this.showEmbed=t},getBuilding:function(t){var e=this;return u(r.a.mark((function a(){var o,s,i,l,c,d;return r.a.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return o=e.user.company_id,a.next=3,axios.all([axios.get(v,{params:{bid:t}}),axios.get(e.api_building_overview(o,t),e.api_header())]);case 3:return s=a.sent,i=s[0].data,l=s[1].data,c=[],l.children.forEach((function(t){var a=i.find((function(e){return e.ref_id==t.id}));t.ordinal_no=Object(n.h)(t.number),t.occupancy_limit=null==a?void 0:a.occupancy_limit,t.floor_plan=null==a?void 0:a.floor_plan,t.floor_plan_url=null!=a&&a.floor_plan?"".concat(e.baseUrl,"/plans/").concat(a.floor_plan):null,delete t.children,delete t.building,c.push(t)})),delete l.children,e.building=l,e.floors=c.sort((function(t,e){return t.number>e.number?1:t.number<e.number?-1:0})),d=e.floor_id?e.floor_id:e.floors[0].id,e.floor=e.floors.find((function(t){return t.id===d})),e.floorFilter="".concat(e.floor.ordinal_no," Floor"),a.next=14,e.getFloorData(d);case 14:e.loaded=!0,setTimeout((function(){e.setFloorMap()}),0);case 16:case"end":return a.stop()}}),a)})))()},getFloorData:function(t){var e=this;return u(r.a.mark((function a(){var o,n,s;return r.a.wrap((function(a){for(;;)switch(a.prev=a.next){case 0:return a.next=2,axios.all([axios.get(e.api_sensors_by_node(t,"Floor"),e.api_header()),axios.get(g,{fid:t})]);case 2:o=a.sent,n=o[0].data,s=o[1].data,n.forEach((function(t){var e=s.find((function(e){return e.ref_id==t.id}));e&&(t.pos_x=e.pos_x,t.pos_y=e.pos_y,t.scale=e.scale)})),e.floor.sensors=n,e.setStats();case 7:case"end":return a.stop()}}),a)})))()},setFloorMap:function(){this.mapper=new l.a("#floor-map",this.floor)},setStats:function(){this.stats.desk_free=this.deskSensors.filter((function(t){return"available"===t.sensor_state})).length,this.stats.desk_occupied=Math.abs(this.deskSensors.length-this.stats.desk_free),this.stats.rooms_free=this.meetingRoomSensors.filter((function(t){return"available"===t.sensor_state})).length,this.stats.rooms_occupied=Math.abs(this.meetingRoomSensors.length-this.stats.rooms_free)},windowResize:function(){this.mapper.redraw()}},created:function(){this.wsConnect()},mounted:function(){this.bldg_id&&this.getBuilding(this.bldg_id),Object(n.a)(window,"beforeunload",this.windowUnload)},destroyed:function(){this.wsClose(),Object(n.g)(window,"beforeunload",this.windowUnload)}},_=(a(113),a(3)),b=Object(_.a)(m,(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("div",{staticClass:"content"},[t.loaded?a("div",{staticClass:"graph-wrapper"},[a("div",{staticClass:"graph-header"},[a("div",{staticClass:"page-back"},[a("div",{staticClass:"back-button",on:{click:t.backTo}},[a("button",{staticClass:"btn btn-primary btn-small"},[a("caret-left-icon")],1),t._v("\n                    Back\n                ")])]),t._v(" "),a("div",{staticClass:"graph-filters"},[a("span",{staticClass:"graph-filter",on:{click:function(e){t.showFilter=!t.showFilter}}},[t._v("\n                    "+t._s(t.floorFilter?t.floorFilter:"Select Floor")+"\n                    "),a("span",{staticClass:"caret"},[a("caret-icon")],1),t._v(" "),a("filter-dropdown",{attrs:{filters:t.floorFilters,show:t.showFilter},on:{onSelect:t.filterSelect}})],1),t._v(" "),a("a",{staticClass:"btn btn-primary ml-12",attrs:{href:"javascript:;"},on:{click:t.toHeatMap}},[t._v("Heatmap")]),t._v(" "),a("a",{staticClass:"btn btn-primary ml-12",attrs:{href:"javascript:;"},on:{click:t.toComfortMap}},[t._v("Comfort Map")])]),t._v(" "),a("span",{staticClass:"page-opt-trigger",attrs:{role:"button"},on:{click:function(e){t.showPageOpts=!t.showPageOpts}}},[a("span",{staticClass:"dot"}),t._v(" "),a("span",{staticClass:"dot"}),t._v(" "),a("span",{staticClass:"dot"})]),t._v(" "),a("transition",{attrs:{name:"fadeUp"}},[t.showPageOpts?a("div",{staticClass:"page-opt-panel"},[a("ul",[a("li",[a("a",{on:{click:function(e){return t.toggleEmbed(!0)}}},[t._v("Embed")])])])]):t._e()])],1),t._v(" "),a("div",{staticClass:"graph-content"},[a("div",{staticClass:"chart-header"},[a("span",{staticClass:"chart-title"},[t._v(t._s(t.floor.ordinal_no+" Floor")+" Live View")]),t._v(" "),a("span",{staticClass:"chart-subtitle"},[t._v(t._s(t.building.name))])]),t._v(" "),a("div",{attrs:{id:"live-view"}},[t._m(0),t._v(" "),a("div",{attrs:{id:"floor-stats"}},[a("div",{attrs:{id:"desk-stats"}},[t._v("\n                        Desks\n                        "),a("div",{staticClass:"stats-wrapper"},[a("div",{staticClass:"stat-group free"},[a("span",{staticClass:"stat"},[t._v(t._s(t.stats.desk_free))]),t._v(" "),a("span",{staticClass:"label"},[t._v("Free")])]),t._v(" "),a("div",{staticClass:"stat-group occupied"},[a("span",{staticClass:"stat"},[t._v(t._s(t.stats.desk_occupied))]),t._v(" "),a("span",{staticClass:"label"},[t._v("Occupied")])])])]),t._v(" "),a("div",{attrs:{id:"meeting-rooms-stats"}},[t._v("\n                        Meeting Rooms\n                        "),a("div",{staticClass:"stats-wrapper"},[a("div",{staticClass:"stat-group free"},[a("span",{staticClass:"stat"},[t._v(t._s(t.stats.rooms_free))]),t._v(" "),a("span",{staticClass:"label"},[t._v("Free")])]),t._v(" "),a("div",{staticClass:"stat-group occupied"},[a("span",{staticClass:"stat"},[t._v(t._s(t.stats.rooms_occupied))]),t._v(" "),a("span",{staticClass:"label"},[t._v("Occupied")])])])])])])])]):t._e(),t._v(" "),a("loader",{attrs:{show:!t.loaded,type:"ripple"}})],1)}),[function(){var t=this.$createElement,e=this._self._c||t;return e("div",{attrs:{id:"floor-plan"}},[e("div",{staticClass:"floor-map",attrs:{id:"floor-map"}})])}],!1,null,"521cbd48",null);e.default=b.exports},48:function(t,e,a){var o=a(114);"string"==typeof o&&(o=[[t.i,o,""]]);var r={hmr:!0,transform:void 0,insertInto:void 0};a(8)(o,r);o.locals&&(t.exports=o.locals)}}]);